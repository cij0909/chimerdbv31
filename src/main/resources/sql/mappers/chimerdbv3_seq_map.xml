<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.com.chimerdbv31.chimerseq.mapper.ChimerSeqMapper">
    <resultMap id="GeneInfoVoMap" type="org.com.chimerdbv31.chimerseq.vo.GeneInfoVo">
        <result property="tax_id" column="tax_id"/>
        <result property="gene_id" column="gene_id"/>
		<result property="symbol" column="symbol"/>
		<result property="locus_tag" column="locus_tag"/>
		<result property="synonyms" column="synonyms"/>
		<result property="dbxrefs" column="dbxrefs"/>
		<result property="chromosome" column="chromosome"/>
		<result property="map_location" column="map_location"/>
		<result property="description" column="description"/>
		<result property="type_of_gene" column="type_of_gene"/>
		<result property="symbol_from_nomenclature_authority" column="symbol_from_nomenclature_authority"/>
		<result property="full_name_from_nomenclature_authority" column="full_name_from_nomenclature_authority"/>
		<result property="nomenclature_status" column="nomenclature_status"/>
		<result property="other_designations" column="other_designations"/>
		<result property="modification_date" column="modification_date"/>

		<collection property="features" javaType="java.util.ArrayList" resultMap="Gff3VoMap"/>
    </resultMap>

    <resultMap id="Gff3VoMap" type="org.com.chimerdbv31.chimerseq.vo.Gff3Vo">
		<result property="seqid" column="seqid"/>
        <result property="source" column="source"/>
		<result property="type" column="type"/>
		<result property="start" column="start"/>
		<result property="end" column="end"/>
		<result property="score" column="score"/>
		<result property="strand" column="strand"/>
		<result property="phase" column="phase"/>
		<result property="attributes" column="attributes"/>
		<result property="elementIndex" column="elementIndex"/>
    </resultMap>

    <select id="getChimerSeqResult" parameterType="org.com.chimerdbv31.common.vo.ParamVo" resultType="org.com.chimerdbv31.chimerseq.vo.ChimerSeqVo">
		SELECT 
			distinct Fusion_pair , 5Gene_Junction as gene5Junc , 3Gene_Junction as gene3Junc , Breakpoint_Type , Cancertype , BarcodeID
			, if(Frame = "NA","",Frame) as Frame
			, Chr_info , Source , ChimerKB , ChimerPub, concat(ChimerKB, "_", ChimerPub) as supported
		FROM ChimerDB3.ChimerSeq_ver7
		WHERE 1=1
        
		<!-- Search method -->
		<choose>
			<when test="searchType == 'byGene'">
				<choose>
					<when test="byGene5Prime == 'on' and byGene3Prime == 'on'">
						AND H_gene = #{byGeneTxt} OR T_gene = #{byGeneTxt}
					</when>
					<when test="byGene5Prime != null and byGene5Prime == 'on'">
						AND H_gene = #{byGeneTxt}
					</when>
					<when test="byGene3Prime != null and byGene3Prime == 'on'">
						AND T_gene = #{byGeneTxt}
					</when>
				</choose>
			</when>
			<when test="searchType == 'byGenePair'">
				AND Fusion_pair = #{byGenePairTxt}
			</when>
			<when test="searchType == 'byChrLocus'">
				AND (H_locus LIKE CONCAT(#{byChrLocusTxt}, '%') OR T_locus LIKE CONCAT(#{byChrLocusTxt}, '%'))
			</when>
			<when test="searchType == 'byDisease'">
				AND Disease LIKE CONCAT(CONCAT('%', #{byDiseaseTxt}), '%')
			</when>
		</choose>
		<choose>
			<when test="cancerTypes.size != 0">
				AND Cancertype IN
				<foreach collection="cancerTypes" item="cancer" index="index" separator="," open="(" close=")">
					#{cancer}
				</foreach>
			</when>
		</choose>
		<choose>
			<when test="sources.size != 0 ">
				AND Source IN
				<foreach collection="sources" item="source" index="index" separator="," open="(" close=")">
					#{source}
				</foreach>
			</when>
		</choose>
		<if test="noOfSeedReads != null and noOfSeedReads >= 0">
			AND Seed_reads_num >= ${noOfSeedReads}
		</if>
		<if test="noOfSpaningPairs != null and noOfSpaningPairs >= 0">
			AND Spanning_pairs_num >= ${noOfSpaningPairs}
		</if>
		<if test="noOfJunctionReads != null and noOfJunctionReads >= 0">
			AND Junction_reads_num >= ${noOfJunctionReads}
		</if>
<!--		<if test="queryForWebSource != null and queryForWebSource != ''"> AND webSource in (${queryForWebSource}) </if>
		<if test="queryForCancerType != null and queryForCancerType != ''"> and Cancertype in (${queryForCancerType}) </if>
		<if test="queryForSource != null and queryForSource != ''"> and (${queryForSource}) </if>
		<if test="queryForFilterByFunc != null and queryForFilterByFunc != ''"> and (${queryForFilterByFunc}) </if>
		<if test="queryForFusType != null and queryForFusType != ''"> and Chr_info in (${queryForFusType}) </if>
		<if test="queryForSupInfo != null and queryForSupInfo != ''"> and (${queryForSupInfo}) </if>
		<if test="sortedKeyword != null"> ORDER BY ${sortedKeyword} ${sortType} </if>-->
<!--            limit ${strtn},${lntn}-->
    </select>
    <select id="getChimerSeqTotalNumber" parameterType="org.com.chimerdbv31.common.vo.ParamVo" resultType="int">
        select distinct count( * ) as allNum
            from ChimerDB3.ChimerSeq_ver5 
            where 1=1
            <choose>
                <when test="searchType == 'by_gene'">
                    <choose>
                        <when test="gene5">
                            and H_gene = "${dataForSearchType}" 
                        </when>
                        <when test="gene3">
                            and T_gene = "${dataForSearchType}" 
                        </when>
                        <when test="gene5 and gene3">
                            and H_gene = "${dataForSearchType}" or T_gene = "${dataForSearchType}" 
                        </when>
                    </choose>
                </when>
                <when test="searchType == 'by_gene_pair'">
                    and Fusion_pair = "${dataForSearchType}" 
                </when>
                <when test="searchType == 'by_chr_locus'">
                    and (H_locus LIKE "${dataForSearchType}%" or T_locus LIKE "${dataForSearchType}%")
                </when>
            </choose>
            <if test="queryForWebSource != null and queryForWebSource != ''"> and webSource in (${queryForWebSource}) </if>
            <if test="queryForCancerType != null and queryForCancerType != ''"> and Cancertype in (${queryForCancerType}) </if>
            <if test="queryForSource != null and queryForSource != ''"> and (${queryForSource}) </if>
            <if test="queryForFilterByFunc != null and queryForFilterByFunc != ''"> and (${queryForFilterByFunc}) </if>
            <if test="queryForFusType != null and queryForFusType != ''"> and Chr_info in (${queryForFusType}) </if>
            <if test="queryForSupInfo != null and queryForSupInfo != ''"> and (${queryForSupInfo}) </if>
    </select>
	
	<select id="getGeneInfo" parameterType="java.lang.String" resultMap="GeneInfoVoMap">
		SELECT * FROM I1_Gene_Info a LEFT JOIN I1_GRCh37_GFF b
		ON b.Gene_ID=a.gene_id
		AND b.no BETWEEN a.gff_start AND a.gff_end
		AND b.type IN ('gene', 'exon', 'mRNA', 'transcript')
		WHERE a.symbol=#{symbol}
		ORDER BY b.no
	</select>
	
	<select id="getGeneFeatureInfo" parameterType="java.lang.String" resultMap="Gff3VoMap">
		SELECT * FROM GRCH37_GFF a, (
			SELECT gene_id, gff_start, gff_end FROM I1_Gene_Info a
			WHERE symbol=#{symbol}
		) b
		WHERE a.Gene_ID=b.gene_id
		AND a.no BETWEEN b.gff_start AND b.gff_end
		AND a.type IN ('gene', 'exon', 'mRNA', 'transcript')
		ORDER BY a.no
	</select>
	
	<select id="getExonElementsWithIndex" parameterType="java.lang.String" resultMap="Gff3VoMap">
		SELECT
			@rownum:=@rownum+1 AS elementIndex
			, a.*
		FROM (
			SELECT a.* FROM I1_GRCh37_GFF a, (
				SELECT max(no) no FROM I1_Gene_Info a LEFT JOIN I1_GRCh37_GFF b
						ON b.Gene_ID=a.gene_id
						AND b.no BETWEEN a.gff_start AND a.gff_end
						AND b.type IN ('exon')
						WHERE a.symbol=#{symbol}
				GROUP BY start, end
			) b
			WHERE a.no=b.no
		) a, (SELECT @rownum:=0) b
	</select>
	
	<select id="getAutocompleteInfo" parameterType="java.util.Map" resultType="java.lang.String">
		SELECT text FROM I2_AutocompleteTable
		WHERE service=#{service} AND type=${type}
		AND MATCH(text) AGAINST('${text}*' IN BOOLEAN MODE)
	</select>
	
	<select id="getTcgaCancerTypes" resultType="java.lang.String">
		SELECT DISTINCT CancerType FROM ChimerSeq_ver7
		ORDER BY CancerType
	</select>
</mapper>